<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width" />
        <link href="http://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet" type="text/css">
        <link href="styles.css" rel="stylesheet" type="text/css">
        <script type="text/javascript" src="js/vendor/seedrandom.js"></script>

        <title>Sentence Gen 2.4.0 Beta</title>

    </head>

    <body>
        <div class="hello">
            <h1>The following sentences have been randomly generated<br>
            according to the rules of English grammar, with some semantic awareness.</h1>
            <p>You can refresh the page to get new sentences, or you can scroll infinitely!</p>
            <!--<p><small>If anything you read offends you, it is your fault for reading it.</small></p>-->
        </div>

        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js" type="text/javascript"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js" type="text/javascript"></script>
        <!--        <script type="text/javascript" src="js/vendor/tabletop.js"></script>-->


        <script type="text/javascript" src="js/utilities.js"></script>
        <script type="text/javascript" src="js/main.js"></script>
        <!--        <script type="text/javascript" src="js/ontology.js"></script>-->
        <script type="text/javascript" src="js/database.processed.js"></script>
        <script type="text/javascript" src="js/database.js"></script>
        <script type="text/javascript" src="js/constructions.js"></script>
        <script type="text/javascript">

            /***** GLOBAL VAARRRRRSSZ! ******/

            var fonts = ("Oswald|Raleway|Roboto+Slab|Yanone+Kaffeesatz|Amatic+SC|Kaushan+Script|Special+Elite"
                         + "|Mountains+of+Christmas|Oldenburg|Sancreek|Sansita+One|Cinzel+Decorative|Abril+Fatface|Pirata+One"
                         + "|Crafty+Girls|Kelly+Slab|Just+Me+Again+Down+Here|Stint+Ultra+Expanded|Flavors|Ribeye+Marrow|Griffy|Alex+Brush|Ceviche+One")
            .replace(/\+/g, " ").split('|')
            var fcounter = 0

            var recentlyUsed = []
            var randy = {}
            var LAST_PARENT = null
            var timer = 0
            var xrayMode = getQueryVariable('mode')=='xray'
            
            var RESTRICTIONS, RESTRICTIONS_BACKUP
            //RESTRICTIONS = {'predicate.name': 'swim','subject.name':'Jack','subject.pronominal':false, 'subject.person':3, 'subject.number':1}
            //RESTRICTIONS = {'predicate.name': 'roll','prep.name':'off of','compext.role':'SOURCE'}
            //RESTRICTIONS = {'predicate.name': 'meet','subject.number':'sg'}
            RESTRICTIONS = {}
            RESTRICTIONS_BACKUP = _.clone(RESTRICTIONS)

            /********************************/


            //random seed
            var seed = getQueryVariable('seed')||Math.random().toString(32).slice(2);
            Math.seedrandom(window.seed)
            _ = _.runInContext() //updates lodash to use seedrandom generator


            function oneRandom(seed){
                //C = new branch(CLAUSE, {tense: "pres", aspect:"simp", number:'pl'})
                Math.seedrandom(window.seed)
                window.lastseed = window.seed
                window.seed = Math.random().toString(32).slice(2)

                recentlyUsed = recentlyUsed.length > 10 ? [] : recentlyUsed //keep track of recently used words so you don't sound dumb repeating yourself

                C = new branch(SENTENCE)
                var sentence = stringOut(C);
                
                console.log(sentence)
                
                RESTRICTIONS = _.clone(RESTRICTIONS_BACKUP)
                return sentence
                //console.log([C.head.head.head.aspect, C.head.head.head.tense, C.head.head.head.number, C.head.head.head.person])
            }

            function loopy(iters){
                var output = ""
                var oneline
                var start = new Date().getTime();

                for(i=0;i<iters;i++,fcounter++) {
                    oneline = oneRandom(seed)
                    oneline = oneline.trim()
                    oneline =  '<div class="sentence">' + oneline.charAt(0).toUpperCase() + oneline.slice(1) + (xrayMode ? '':'.') +'<span class="seed">'+window.lastseed+'</span></div>'
                    oneline = $(oneline).css({"font-family": fonts[fcounter%fonts.length]})
                    $(oneline).data({c:C})
                    $('body').append(oneline)
                }

                $('.label').off('click').click(randomizer)

                var end = new Date().getTime();
                //console.log(end-start)
                //console.log("Timer: " + timer)
            }

            //console.time("full")

            $(function(){

                while( ($('body').height() - $(window).height()) < 0 ){
                    loopy(3);
                }
                setTimeout(function(){
                    loopy(getQueryVariable('howmany'))
                },50)

                $('head').append("<link href='http://fonts.googleapis.com/css?family=Flavors|Ribeye+Marrow|Griffy|Stint+Ultra+Expanded|Alex+Brush|Ceviche+One|Crafty+Girls|Kelly+Slab|Just+Me+Again+Down+Here|Oswald|Raleway:200|Yanone+Kaffeesatz|Amatic+SC|Kaushan+Script|Special+Elite|Mountains+of+Christmas|Oldenburg|Sancreek|Sansita+One|Abril+Fatface|Pirata+One|Cinzel+Decorative' rel='stylesheet' type='text/css'>")
                //console.timeEnd("full");
                //console.timeEnd("sentence loop");

            })



            $(window).scroll(function(){

                var wintop = $(window).scrollTop(), docheight = $(document).height(), winheight = $(window).height();

                if  ($(window).scrollTop() > $(document).height() - $(window).height() - 100) {
                    loopy(5)
                }

            });

            var SENGEN = (function (m) {

                return m;

            }(SENGEN || {}));
            //LABjs

            //for xray mode, handler for clicking on parts of sentence
            function randomizer(){
                var here = $(this).parent()
                var id = here.attr('id').slice(1,-1)
                var top = C = $(this).parents('.sentence').data('c')
                var c = top.list[+id-1]
               console.log(c.restrictions);
               //console.log(c);
                if (here.hasClass('head')) {
                    var R
                    if (R = parseSingleRestriction(c.label+'.R',c,true)) {
                       c.restrictions =  _.extend(c.restrictions,R)

                       //heads with complements must update their complements as well
                       //this is a whole lot of trouble, maybe better to just update whole parent
                       var comp
                       if (c.parent && (comp = c.parent.hasComplement)) {
                           var compArray = comp.split(/ *, */)
                           var p = c.parent
                           p.restrictions =  _.extend(p.restrictions,R)
                           var notherBranch = new branch(p.construction, p.restrictions, p.parent, p.label )
                           if (notherBranch.actualHead) notherBranch.head = notherBranch.children[notherBranch.actualHead]
                           var compBranches = _.pick(notherBranch.children, compArray)

                           //update branches
                           $.each(compBranches,function(key, val){
                                                    //class names have dashes on the end to avoid potential css conflicts
                                var compClass = key.replace(/([\w-]+)/g,'.$1-')
                                var compElement = here.parents('.constituent').first().find(compClass).first()
                                var newElement = stringOut(val)
                                var updateFunction
                                if (newElement) {
                                    updateFunction = function() {
                                        // we will replace the construction in C.list rather than append a new one
                                        // since we are changing the inner html, not replacing the whole element
                                        var id = compElement.attr('id').slice(1,-1)
                                        compElement.html($(stringOut(val,id)).html())
                                        .find('.label').click(randomizer)
                                    }
                                } else {
                                    updateFunction = function() {
                                        compElement.html('')
                                    }
                                }
                                setTimeout(function() {
                                    animateElement.apply(this, [compElement, updateFunction])
                                }, 200)
                           })

                           //update head
                           updateFunction = function() {
                               var newHead = $(stringOut(notherBranch.head)).children('.construction')
                               if (newHead.length == 0) newHead = $('<div class="construction">'+smiley()+'</div>')
                               newHead.find('.label').click(randomizer)
                               here.children('.construction').replaceWith( newHead  )
                           }
                           animateElement.apply(this, [here,updateFunction])

                           return
                       }

                    } else {
                        return
                    }
                    //here = here.parents(".constituent:not(.head)")
                }

                updateFunction = function() {
                    var newBranch = $(stringOut(new branch(c.construction, c.restrictions, c.parent, c.label ))).children('.construction')
                    if (newBranch.length) {
                         newBranch.find('.label').click(randomizer)
                        here.children('.construction').replaceWith( newBranch )
                    } else {
                        here.children('.construction').html(smiley())
                    }

                }
                animateElement.apply(this, [here,updateFunction])
            }

            function animateElement(el,updateFunc) {
                var oldWidth = el.width();
                var oldHeight = el.height();
                el.animateCSS('bounce')
//                el.width('auto');
//                el.height('auto');
                updateFunc()
//                el.width(el.width());
//                el.height(el.height());
                var newWidth = el.width();
                var newHeight = el.height();
                el.width(oldWidth);
                el.height(oldHeight);
                el.animate({width: newWidth, height: newHeight}, 500, function() {
                    el.width('auto'); el.height('auto');
                });
            }
            $.fn.extend({
                animateCSS: function (animationName) {
                    var animationEnd = 'webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend';
                    $(this).addClass('animated ' + animationName).one(animationEnd, function() {
                        $(this).removeClass('animated ' + animationName);
                    });
                }
            });

            function smiley(){
                var smiley = _.sample([':)',':(',';)',':/','^_^','o.O',':|'])
                return $('<span>').addClass('smiley').html(smiley).prop('outerHTML')
            }

        </script>
    </body>
</html>
